<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Host App</title>
  </head>
  <body>
    <h1>Host Application</h1>
    <button id="sendEventBtn">Send Event via MutationObserver</button>
    <div id="remote-container"></div>

    <script>
      const modulePath = "http://localhost:5003"; // where CSS/JS should load from

      fetch(`${modulePath}/index.html`)
        .then((res) => res.text())
        .then((html) => {
          // Adjust relative paths to absolute remote URLs
          const adjustedHtml = html
            .replace(/(href|src)="\//g, `$1="${modulePath}/`)
            .replace(/(href|src)="\.?\/*/g, `$1="${modulePath}/`);

          // Create a container
          const container = document.createElement("div");
          container.innerHTML = adjustedHtml;

          // âœ… Append CSS links
          const arrLinks = container.getElementsByTagName("link");
          for (const link of arrLinks) {
            if (link.href.includes(modulePath)) {
              document.head.appendChild(link.cloneNode(true));
            }
          }

          // âœ… Inject into host
          document.getElementById("remote-container").appendChild(container);

          const elemJS = container.getElementsByTagName("script")[0];
          const elemSScript = document.createElement("script");
          elemSScript.type = elemJS.type;
          elemSScript.src = elemJS.src;
          document.getElementById("remote-container").appendChild(elemSScript);

          // âœ… Button -> trigger DOM mutation (message carrier)
          document
            .getElementById("sendEventBtn")
            .addEventListener("click", () => {
              const remoteContainer = document.getElementById("remote-container");

              // Create or update a "message node"
              let msgNode = remoteContainer.querySelector("#host-message");
              if (!msgNode) {
                msgNode = document.createElement("div");
                msgNode.id = "host-message";
                msgNode.style.display = "none"; // hidden
                remoteContainer.appendChild(msgNode);
              }

              // Update message (this triggers MutationObserver in MFE)
              msgNode.textContent = JSON.stringify({
                time: new Date().toISOString(),
                message: "Hello from Host App ðŸš€",
              });

              console.log("âœ… Host mutated DOM with message");
            });
        })
        .catch((err) => console.error("Failed to load app:", err));
    </script>
  </body>
</html>
